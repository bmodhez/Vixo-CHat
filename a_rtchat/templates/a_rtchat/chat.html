{% extends 'base.html' %}

{% block content %}
<wrapper class="block w-full">
    <div class="flex gap-6">

        <aside class="w-72 shrink-0 h-[45rem] bg-gray-900/60 border border-gray-800 rounded-2xl shadow-2xl p-4 overflow-y-auto">
            <div class="text-sm font-semibold text-gray-200 mb-3">Chats</div>

            <div class="mb-4">
                <a href="{% url 'chatroom' 'public-chat' %}"
                   class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60
                   {% if chat_group.group_name == 'public-chat' %}text-emerald-400 font-semibold{% else %}text-gray-300{% endif %}">
                    Public chat
                </a>
            </div>

            {% if sidebar_groupchats %}
                <div class="text-xs font-semibold text-gray-400 mb-2">Group chats</div>
                <ul class="space-y-1 mb-4">
                    {% for room in sidebar_groupchats %}
                        <li>
                            <a href="{% url 'chatroom' room.group_name %}"
                               class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60
                               {% if chat_group.group_name == room.group_name %}text-emerald-400 font-semibold{% else %}text-gray-300{% endif %}">
                                {{ room.groupchat_name|default:room.group_name|slice:":30" }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            <div class="text-xs font-semibold text-gray-400 mb-2">Private rooms</div>
            <div class="space-y-2 mb-4">
                <form method="post" action="{% url 'private-room-create' %}" class="space-y-2">
                    {% csrf_token %}
                    {{ private_room_create_form.name }}
                    <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors">
                        Create private room
                    </button>
                </form>

                <form method="post" action="{% url 'private-room-join' %}" class="space-y-2">
                    {% csrf_token %}
                    {{ room_code_join_form.code }}
                    <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors">
                        Enter room code
                    </button>
                </form>
            </div>

            {% if sidebar_code_rooms %}
                <div class="text-xs font-semibold text-gray-400 mb-2">Your private rooms</div>
                <ul class="space-y-1 mb-4">
                    {% for room in sidebar_code_rooms %}
                        <li>
                            <a href="{% url 'chatroom' room.group_name %}"
                               class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60
                               {% if chat_group.group_name == room.group_name %}text-emerald-400 font-semibold{% else %}text-gray-300{% endif %}">
                                {{ room.code_room_name|default:room.room_code|slice:":30" }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            {% if sidebar_privatechats %}
                <div class="text-xs font-semibold text-gray-400 mb-2">Direct</div>
                <ul class="space-y-1">
                    {% for room in sidebar_privatechats %}
                        <li>
                            <a href="{% url 'chatroom' room.group_name %}"
                               class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60
                               {% if chat_group.group_name == room.group_name %}text-emerald-400 font-semibold{% else %}text-gray-300{% endif %}">
                                {% for member in room.members.all %}
                                    {% if member != user %}
                                        {{ member.profile.name|default:member.username|slice:":30" }}
                                    {% endif %}
                                {% endfor %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </aside>

        <div id="chat_window" class="h-[45rem] flex flex-col bg-gray-900/60 border border-gray-800 rounded-2xl shadow-2xl relative p-1 grow">
        
        <div class="flex items-center justify-between text-emerald-400 bg-gray-900/60 p-2 sticky top-0 z-10 border-b border-gray-800 rounded-t-2xl">
            <div class="flex items-center">
                <span id="online-count" class="pr-1 font-bold">{{ chat_group.users_online.count }}</span> online
                {% if chat_group.is_code_room and chat_group.room_code %}
                    <span class="ml-3 text-xs text-gray-300">Room code: <span class="font-semibold text-emerald-400">{{ chat_group.room_code }}</span></span>
                {% endif %}
            </div>

            {% if chat_group.is_private %}
                <div class="flex items-center gap-2">
                    <a data-call-btn data-call-type="voice" href="{% url 'chat-call' chatroom_name %}?type=voice" class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors">
                        Voice call
                    </a>
                    <a data-call-btn data-call-type="video" href="{% url 'chat-call' chatroom_name %}?type=video" class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors">
                        Video call
                    </a>
                </div>
            {% endif %}

            {% if chat_group.admin and user == chat_group.admin %}
                <form method="post" action="{% url 'chatroom-close' chatroom_name %}"
                      data-confirm="Close this room? This will delete the room and all messages/uploads."
                      data-confirm-title="Close room">
                    {% csrf_token %}
                    <button type="submit" class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors">
                        Close room
                    </button>
                </form>
            {% endif %}
        </div>

        <div id='chat_container' class="overflow-y-auto grow p-4">
            <ul id='chat_messages' class="flex flex-col justify-end gap-2">
                {% for message in chat_messages %}
                    {% include 'a_rtchat/chat_message.html' %}
                {% endfor %}
            </ul>
        </div>

        <div class="sticky bottom-0 z-10 p-4 bg-gray-900/60 border-t border-gray-800 rounded-b-2xl">
            <form id="chat_message_form" class="flex items-center gap-2"
                hx-post="{{ request.path }}"
                hx-target="#chat_messages"
                hx-swap="none"
                hx-on:htmx:after-request="document.getElementById('id_body').value = ''; scrollToBottom();">
                {% csrf_token %}

                {{ form.body }} <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-4 py-2 transition-colors">
                    Send
                </button>
            </form>

            {% if chat_group.is_private and chat_group.is_code_room %}
                <div class="mt-3">
                    <form id="chat_file_form"
                          class="flex items-center gap-2"
                          hx-post="{% url 'chat-file-upload' chatroom_name %}"
                          hx-target="#upload_feedback"
                          hx-swap="innerHTML"
                          hx-encoding="multipart/form-data"
                          hx-on:chatFileUploaded="document.getElementById('chat_file_input').value='';">
                        {% csrf_token %}

                        <input id="chat_file_input" name="file" type="file" accept="image/*,video/*"
                               class="block w-full text-sm text-gray-300 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-800 file:text-white hover:file:bg-gray-700"
                               {% if uploads_remaining == 0 %}disabled{% endif %} />

                        <button type="submit"
                                class="bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-4 py-2 transition-colors text-sm"
                                {% if uploads_remaining == 0 %}disabled{% endif %}>
                            Upload{% if upload_limit %} ({{ uploads_used }}/{{ upload_limit }} used){% endif %}
                        </button>
                    </form>
                    <div id="upload_feedback" class="mt-2"></div>
                    {% if uploads_remaining == 0 %}
                        <div class="text-xs text-gray-400 mt-1">Upload limit reached for this room.</div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        </div>

    </div>
</wrapper>

<script>
    (function () {
        const chatroomName = "{{ chatroom_name|escapejs }}";
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${wsScheme}://${window.location.host}/ws/chatroom/${chatroomName}`;
        const pollUrl = "{% url 'chat-poll' chatroom_name %}";
        const inviteUrl = "{% url 'chat-call-invite' chatroom_name %}";
            const callBaseUrl = "{% url 'chat-call' chatroom_name %}";
        const callEventUrl = "{% url 'chat-call-event' chatroom_name %}";

            // -------- Ringtone (incoming) --------
            let audioCtx = null;
            let ringTimer = null;
            let audioUnlocked = false;

            function unlockAudioOnce() {
                if (audioUnlocked) return;
                try {
                    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                    // create a tiny silent buffer to unlock
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    g.gain.value = 0.00001;
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.start();
                    o.stop(audioCtx.currentTime + 0.01);
                    audioUnlocked = true;
                } catch {
                    // ignore
                }
            }

            document.addEventListener('click', unlockAudioOnce, { once: true, capture: true });

            function stopIncomingRing() {
                if (ringTimer) {
                    clearInterval(ringTimer);
                    ringTimer = null;
                }
            }

            function playIncomingRing() {
                // Browsers may block until user interacts; we try best-effort.
                try {
                    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                    if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
                } catch {
                    return;
                }

                stopIncomingRing();

                const ringOnce = () => {
                    try {
                        const ctx = audioCtx;
                        const now = ctx.currentTime;
                        const g = ctx.createGain();
                        g.gain.setValueAtTime(0.0001, now);
                        g.gain.exponentialRampToValueAtTime(0.15, now + 0.02);
                        g.gain.exponentialRampToValueAtTime(0.0001, now + 1.8);
                        g.connect(ctx.destination);

                        const o1 = ctx.createOscillator();
                        const o2 = ctx.createOscillator();
                        o1.type = 'sine';
                        o2.type = 'sine';
                        o1.frequency.setValueAtTime(480, now);
                        o2.frequency.setValueAtTime(620, now);
                        o1.connect(g);
                        o2.connect(g);
                        o1.start(now);
                        o2.start(now);
                        o1.stop(now + 1.9);
                        o2.stop(now + 1.9);
                    } catch {
                        // ignore
                    }
                };

                // Classic ring cadence: ring ~2s, pause ~3s
                ringOnce();
                ringTimer = setInterval(ringOnce, 5000);
            }

        const form = document.getElementById('chat_message_form');
        const input = document.getElementById('id_body');
        const messagesEl = document.getElementById('chat_messages');
        const onlineCountEl = document.getElementById('online-count');

        let socket = null;
        let wsConnected = false;
        let lastId = 0;

        function safeScrollToBottom() {
            if (typeof scrollToBottom === 'function') scrollToBottom();
        }

        function updateLastIdFromDom() {
            const last = messagesEl && messagesEl.lastElementChild;
            const id = last && last.dataset ? parseInt(last.dataset.messageId || '0', 10) : 0;
            if (!Number.isNaN(id) && id > lastId) lastId = id;
        }

        function connect() {
            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                wsConnected = true;
                scrollToBottom();
            };

            socket.onmessage = function (event) {
                let payload;
                try {
                    payload = JSON.parse(event.data);
                } catch {
                    // Ignore unexpected non-JSON frames
                    return;
                }

                if (payload.type === 'chat_message' && payload.html) {
                    messagesEl.insertAdjacentHTML('beforeend', payload.html);
                    updateLastIdFromDom();
                    safeScrollToBottom();
                    return;
                }

                if (payload.type === 'online_count' && typeof payload.online_count !== 'undefined') {
                    if (onlineCountEl) onlineCountEl.textContent = payload.online_count;
                }

                if (payload.type === 'call_invite') {
                    if (!window.__hasGlobalCallInvite) {
                        showIncomingCall(payload);
                    }
                }
            };

            socket.onclose = function () {
                wsConnected = false;
                // Simple reconnect
                setTimeout(connect, 1000);
            };

            socket.onerror = function () {
                wsConnected = false;
            };
        }

        // Ensure correct position on initial render
        document.addEventListener('DOMContentLoaded', function () {
            updateLastIdFromDom();
            safeScrollToBottom();
        });

        function ensureIncomingContainer() {
            let c = document.getElementById('incoming-call-container');
            if (c) return c;
            c = document.createElement('div');
            c.id = 'incoming-call-container';
            c.className = 'fixed top-24 right-6 z-50 w-[min(24rem,calc(100vw-3rem))] space-y-3';
            document.body.appendChild(c);
            return c;
        }

        function showIncomingCall(payload) {
            const container = ensureIncomingContainer();
            const from = payload.from_username || 'Someone';
            const type = (payload.call_type || 'voice').toLowerCase() === 'video' ? 'video' : 'voice';

            playIncomingRing();

            const toast = document.createElement('div');
            toast.className = 'pointer-events-auto flex items-start gap-3 rounded-xl border border-gray-800 bg-gray-900/90 px-4 py-3 text-sm text-gray-100 shadow-lg shadow-black/20';
            toast.innerHTML = `
                <div class="mt-0.5 h-2.5 w-2.5 flex-none rounded-full bg-emerald-400"></div>
                <div class="flex-1">
                    <div class="font-semibold">Incoming ${type === 'video' ? 'video' : 'voice'} call</div>
                    <div class="text-gray-300 text-xs mt-0.5">from ${from}</div>
                    <div class="mt-3 flex gap-2">
                        <a href="${callBaseUrl}?type=${type}&role=callee" class="text-xs bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg transition-colors">Accept</a>
                        <button type="button" data-decline class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors">Decline</button>
                    </div>
                </div>
                <button type="button" data-close class="-mr-1 -mt-1 inline-flex h-8 w-8 items-center justify-center rounded-lg text-gray-300 hover:text-white hover:bg-gray-800/60 transition" aria-label="Dismiss">
                    <span aria-hidden="true">Ã—</span>
                </button>
            `;

            const removeToast = () => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 200);
                stopIncomingRing();
            };
            toast.querySelector('[data-close]')?.addEventListener('click', removeToast);
            toast.querySelector('[data-decline]')?.addEventListener('click', async () => {
                try {
                    const body = new URLSearchParams();
                    body.set('action', 'decline');
                    body.set('type', type);
                    await fetch(callEventUrl, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                        },
                        body,
                    });
                } catch {
                    // ignore
                }
                removeToast();
            });
            setTimeout(removeToast, 15000);

            // Stop ring immediately if user accepts (navigation)
            const accept = toast.querySelector('a');
            if (accept) accept.addEventListener('click', stopIncomingRing);

            container.appendChild(toast);
        }

        // When clicking call buttons, notify the other member first, then navigate.
        document.addEventListener('click', async function (e) {
            const a = e.target && e.target.closest ? e.target.closest('[data-call-btn]') : null;
            if (!a) return;
            e.preventDefault();

            const type = a.getAttribute('data-call-type') || 'voice';
            try {
                const body = new URLSearchParams();
                body.set('type', type);
                await fetch(inviteUrl, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                    },
                    body,
                });
            } catch {
                // ignore
            }
            const url = new URL(a.href, window.location.origin);
            url.searchParams.set('role', 'caller');
            window.location.href = url.toString();
        }, true);

        async function poll() {
            // Fallback: if websocket isn't connected, poll for new messages
            if (wsConnected) return;
            try {
                updateLastIdFromDom();
                const res = await fetch(`${pollUrl}?after=${lastId}`, { credentials: 'same-origin' });
                if (!res.ok) return;
                const data = await res.json();
                if (data && typeof data.online_count !== 'undefined') {
                    if (onlineCountEl) onlineCountEl.textContent = data.online_count;
                }
                if (data && data.messages_html) {
                    messagesEl.insertAdjacentHTML('beforeend', data.messages_html);
                    updateLastIdFromDom();
                    safeScrollToBottom();
                }
                if (data && typeof data.last_id !== 'undefined') {
                    const newLast = parseInt(String(data.last_id), 10);
                    if (!Number.isNaN(newLast) && newLast > lastId) lastId = newLast;
                }
            } catch {
                // ignore
            }
        }

        setInterval(poll, 1200);
        connect();
    })();
</script>

<style>
    @keyframes fadeInAndUp {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0px); }
    }
    .fade-in-up {
        animation: fadeInAndUp 0.35s ease;
    }

    /* Custom Scrollbar for Chat */
    #chat_container::-webkit-scrollbar { width: 6px; }
    #chat_container::-webkit-scrollbar-track { background: transparent; }
    #chat_container::-webkit-scrollbar-thumb { background: rgb(75 85 99); border-radius: 9999px; }
    #chat_container::-webkit-scrollbar-thumb:hover { background: rgb(16 185 129); }
</style>
{% endblock %}